@startuml sequence_diagram_rotate_watchlist_calendar_token
title Rotate Watchlist Calendar Token - Sequence Diagram

actor User
participant "Application" as APP
database "SQL Database" as DB

User -> APP: POST /api/watchlists/{watchlist_id}/rotate

== Authentication & Validation ==
APP -> APP: Validate user authentication and permission

== Check Watchlist Ownership ==
APP -> DB: SELECT * FROM watchlist WHERE id=:watchlist_id AND user_id=:user_id
alt watchlist not found
  APP --> User: 404 Not Found
else watchlist found
  == Generate New Token ==
  APP -> DB: UPDATE watchlist SET calendar_token = gen_token() WHERE id=:watchlist_id\nRETURNING calendar_token
  APP --> User: 200 OK { calendar_token }
end
@enduml
