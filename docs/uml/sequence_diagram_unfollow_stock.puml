@startuml sequence_diagram_unfollow_stock
title Unfollow Stock - Sequence Diagram

actor User
participant "Application" as APP
database "SQL Database" as DB

User -> APP: DELETE /api/stocks/unfollow\n{ ticker: "AAPL", watchlist_id: "USA" }

== Authentication & Validation ==
APP -> APP: Validate user authentication and permission
APP -> APP: Validate payload

== Find Stock ID ==
APP -> DB: SELECT id FROM stock WHERE ticker = :ticker
DB --> APP: stock_id

== Check Follow Relationship ==
APP -> DB: SELECT * FROM follow WHERE watchlist_id = :watchlist_id AND stock_id = :stock_id

alt follow relationship not found
    APP --> User: 404 Not Found { code: NOT_FOLLOWING_STOCK }
else follow relationship exists
    == Remove Follow Relationship ==
    APP -> DB: DELETE FROM follow WHERE watchlist_id = :watchlist_id AND stock_id = :stock_id
    
    == Check if Stock Data Still Needed ==
    APP -> DB: SELECT COUNT(*) FROM follow WHERE stock_id = :stock_id
    
    alt no other users follow this stock
        APP -> DB: DELETE FROM stock_event WHERE stock_id = :stock_id
        APP -> DB: DELETE FROM stock WHERE id = :stock_id
    end
    
    == Success Response ==
    APP --> User: 200 OK { message: "Successfully unfollowed stock" }
end
@enduml