name: Create Release from PR

on:
  pull_request:
    types: [closed]
    branches:
      - main

permissions:
    contents: write
    packages: write

jobs:
  build-image:
    if: github.event.pull_request.merged == true
    uses: ./.github/workflows/docker-image.yaml
    permissions:
        contents: read
        packages: write

  release-from-pr:
    needs: build-image
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
       
    steps:
      - name: Extract version from PR title
        id: version
        run: |
          title="${{ github.event.pull_request.title }}"
          echo "PR title: $title"

          # Accept (v1.2.3, v01.02.300, v1.2.3-alpha) and the same without 'v'
          if echo "$title" | grep -Eq '^v[0-9]+(\.[0-9]+){2}(-[0-9A-Za-z.-]+)?$'; then
            version="$title"
          elif echo "$title" | grep -Eq '^[0-9]+(\.[0-9]+){2}(-[0-9A-Za-z.-]+)?$'; then
            version="v$title"
          else
            echo "PR title is not a valid version (expected vX.Y.Z, vX.Y.Z-suffix, or X.Y.Z, got: $title)"
            exit 1
          fi

          echo "Using version: $version"
          echo "version=$version" >> "$GITHUB_OUTPUT"

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
                
      - name: Create git tag for merge commit
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          MERGE_SHA="${{ github.event.pull_request.merge_commit_sha }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          echo "Tagging commit $MERGE_SHA with $VERSION"
          git tag "$VERSION" "$MERGE_SHA"
          git push origin "$VERSION"

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Retag Docker image with release version as tarball
        run: |
          REPO_LOWER="$(echo "${GITHUB_REPOSITORY}" | tr '[:upper:]' '[:lower:]')"
          MERGE_SHA="${{ github.event.pull_request.merge_commit_sha }}"
          VERSION="${{ steps.version.outputs.version }}"

          SHA_TAG="ghcr.io/${REPO_LOWER}:sha-${MERGE_SHA}"
          RELEASE_TAG="ghcr.io/${REPO_LOWER}:${VERSION}"

          echo "Pulling $SHA_TAG"
          docker pull "$SHA_TAG"
          
          echo "Tagging $SHA_TAG as $RELEASE_TAG"
          docker tag "$SHA_TAG" "$RELEASE_TAG"

          echo "Pushing $RELEASE_TAG"
          docker push "$RELEASE_TAG"

          TARBALL="docker-image-${VERSION}.tar.gz"
          echo "Saving $RELEASE_TAG to $TARBALL"
          docker save "$RELEASE_TAG" | gzip > "$TARBALL"
          ls -lh "$TARBALL"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: ${{ steps.version.outputs.version }}
          generate_release_notes: true
          files: docker-image-${{ steps.version.outputs.version }}.tar.gz
          draft: false
          prerelease: false
